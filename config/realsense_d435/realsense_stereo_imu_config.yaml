%YAML:1.0
# ============================================================================
# VINS-Fusion ROS2 配置文件 - RealSense D435
# ============================================================================
# 硬件: Intel RealSense D435 (双目红外相机) + PX4 ICM-42688-P IMU
# 标定来源: Kalibr 相机-IMU 标定 (S 级标定)
# 标定日期: 2025-11-17
# 标定质量:
#   - 重投影误差: 0.18 px (cam0), 0.18 px (cam1) - S 级卓越
#   - IMU 陀螺仪残差: 0.85 σ - 卓越
#   - IMU 加速度计残差: 0.40 σ - 卓越
#   - 时间偏移: -14.18 ms (两相机差异 0.06 ms - 极佳)
#   - 双目基线: 50.040 mm (误差 0.08% - 完美)
# ============================================================================

#common parameters
#support: 1 imu 1 cam; 1 imu 2 cam: 2 cam;
imu: 1         # 使用 IMU (1 = 启用, 0 = 禁用)
num_of_cam: 2  # 双目相机

# ROS2 topic 配置
imu_topic: "/vins/imu"
image0_topic: "/camera/camera/infra1/image_rect_raw"
image1_topic: "/camera/camera/infra2/image_rect_raw"
output_path: "/home/fsuav/fast-drone-250-humble-6.1/vins_output"

# 相机内参文件 (同目录下的 left.yaml 和 right.yaml)
cam0_calib: "left.yaml"
cam1_calib: "right.yaml"
image_width: 640
image_height: 480

# GPU 加速 (需要 CUDA 支持的 OpenCV)
use_gpu         : 0  # 禁用 GPU (默认 CPU 模式)
use_gpu_acc_flow: 0  # 禁用 GPU 光流加速
use_gpu_ceres   : 0  # 禁用 GPU Ceres 优化

# ============================================================================
# 相机-IMU 外参 (Camera-IMU Extrinsics)
# ============================================================================
# 说明: body_T_cam = T_ic (cam to imu 变换)
# 来源: Kalibr 标定结果的 T_ic 矩阵
# 物理意义: 描述相机相对于 IMU 的位置和姿态
# ============================================================================

# 外参估计模式
estimate_extrinsic: 0   # 0: 完全信任标定结果 (推荐 - S 级标定)
                        # 1: 在初始值附近优化 (如果标定不够精确)
                        # 2: 从头开始标定 (不推荐)

# Cam0 (左相机) 到 IMU 的变换矩阵
# 平移向量: X=-12.9mm, Y=57.1mm, Z=-23.6mm (相机位于IMU右前上方)
# 旋转: Yaw ≈ -91.37° (相机光轴指向前方,相对IMU有90°偏转)
body_T_cam0: !!opencv-matrix
   rows: 4
   cols: 4
   dt: d
   data: [ -2.3896839096390732e-02, -1.4179502073398575e-02,
       9.9961386685167270e-01, 2.4125580000000000e-02,
       -9.9971418610149710e-01, 1.0370601244308330e-03,
       -2.3884526658937200e-02, -1.3547110000000000e-02,
       -6.9798898585743400e-04, -9.9989892800585150e-01,
       -1.4200231833559063e-02, 5.6721640000000000e-02, 0., 0., 0., 1. ]

# Cam1 (右相机) 到 IMU 的变换矩阵
# 平移向量: X=-63.0mm, Y=57.1mm, Z=-24.0mm
# 双目基线: 50.04 mm (X 轴方向, 与 D435 规格 50mm 完美匹配)
body_T_cam1: !!opencv-matrix
   rows: 4
   cols: 4
   dt: d
   data: [ -2.2577657162586667e-02, -1.5445343296898895e-02,
       9.9962577536170480e-01, 2.3404570000000000e-02,
       -9.9974468611668120e-01, 1.2500291229582405e-03,
       -2.2561028537068928e-02, -6.3582190000000000e-02,
       -9.0109850037567440e-04, -9.9987993219067680e-01,
       -1.5469622615303963e-02, 5.6645820000000000e-02, 0., 0., 0., 1. ]

# ============================================================================
# 线程配置
# ============================================================================
#Multiple thread support
multiple_thread: 1  # 启用多线程 (提升性能)

# ============================================================================
# 特征跟踪参数 (Feature Tracker Parameters)
# ============================================================================
max_cnt: 150            # 最大特征点数量 (建议 100-200)
min_dist: 30            # 特征点间最小距离 (像素) (建议 20-40)
freq: 15                # 特征跟踪发布频率 (Hz) (至少 10Hz)
F_threshold: 1.0        # RANSAC 阈值 (像素)
show_track: 1           # 发布特征跟踪图像 (1 = 启用)
flow_back: 1            # 前向-后向光流验证 (提升精度)

# ============================================================================
# 优化参数 (Optimization Parameters)
# ============================================================================
# 2025-11-19 VINS发散修复: 优化Ceres参数解决NO_CONVERGENCE问题
# 问题: 优化器频繁达到max_iter=8但未收敛, 导致处理延迟堆积
# 解决: 降低max_solver_time确保15fps下能完成, 增加迭代次数提高收敛率
# ============================================================================
max_solver_time: 0.05   # 最大求解时间 (秒) - 从0.04增加到0.05
                        # 原因: 给优化器更多时间完全收敛,避免NO_CONVERGENCE
                        # 15fps下处理周期66ms, 留50ms给优化仍有16ms余量
max_num_iterations: 12  # 最大迭代次数 - 从8增加到12
                        # 原因: 提高收敛成功率,减少因未收敛导致的延迟
                        # 日志显示需要9次迭代才收敛,8次不够
keyframe_parallax: 10.0 # 关键帧选择阈值 (像素)

# ========================================================================
# 原始参数 (已弃用, 保留备份)
# ========================================================================
# max_solver_time: 0.04   # 原40ms, 在30fps下太紧张(33ms周期)
# max_num_iterations: 8   # 原8次, 不足以收敛(日志显示需要9次)
# 问题表现: Ceres优化完成: 迭代次数=9, 终止原因=NO_CONVERGENCE
# ========================================================================

# ============================================================================
# IMU 噪声参数 (IMU Noise Parameters)
# ============================================================================
# 来源: Allan 方差标定 (2025-11-13/14, 4 份独立 3 小时数据)
# 传感器: PX4 ICM-42688-P
# 采样率: 200 Hz
# 标定质量: 优秀 (变异系数 CV < 10%)
# 注意: 这些参数对 VIO 融合精度至关重要!
# ============================================================================

# 加速度计测量噪声标准差 [m/s²/√Hz]
# 标定值: 0.00370 m/s²/√Hz
# 影响: 决定 IMU 加速度测量的短期白噪声水平
acc_n: 0.0036962596

# 陀螺仪测量噪声标准差 [rad/s/√Hz]
# 标定值: 0.0000768 rad/s/√Hz (与 ICM-42688-P 数据手册吻合)
# 影响: 决定 IMU 角速度测量的短期白噪声水平
gyr_n: 0.0000768388

# 加速度计 bias 随机游走 [m/s²√s]
# 标定值: 0.000476 m/s²√s
# 影响: 决定加速度计 bias 的长期漂移速率
acc_w: 0.0004762768

# 陀螺仪 bias 随机游走 [rad/s√s]
# 标定值: 0.0000072 rad/s√s
# 影响: 决定陀螺仪 bias 的长期漂移速率
gyr_w: 0.0000071650

# 重力加速度 [m/s²]
g_norm: 9.795

# ============================================================================
# 时间同步参数 (Time Synchronization Parameters)
# ============================================================================
# 说明: td = t_imu - t_cam (IMU 时间戳 - 相机时间戳)
# 物理意义: IMU 时间戳领先相机 14.18 毫秒
# ============================================================================

# 时间偏移在线估计
estimate_td: 0  # 0: 信任标定值 (推荐 - S 级标定)
                # 1: 在线估计时间偏移 (如果标定不够精确)

# 时间偏移初始值 [秒]
# 标定值: -14.21 ms (cam0), -14.15 ms (cam1)
# 使用平均值: -14.18 ms
td: -0.014182214771096076

# ============================================================================
# 闭环检测参数 (Loop Closure Parameters)
# ============================================================================
load_previous_pose_graph: 0  # 加载之前的位姿图 (0 = 禁用)
pose_graph_save_path: "/home/fsuav/fast-drone-250-humble-6.1/vins_output/pose_graph/"  # 位姿图保存路径
save_image: 1  # 保存闭环图像 (0 = 禁用, 节省存储)
